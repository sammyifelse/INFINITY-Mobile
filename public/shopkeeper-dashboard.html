<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopkeeper Dashboard - Infinity Mobile</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body style="background: #f9fafb;">
    <div class="dashboard">
        <div class="dashboard-header">
            <div>
                <h1>üì± Infinity Mobile</h1>
                <p>Place Your Order</p>
            </div>
            <div style="background: linear-gradient(135deg, #ff9800, #ff5722); color: white; padding: 18px 30px; border-radius: 16px; text-align: center; box-shadow: 0 8px 20px rgba(255, 152, 0, 0.35); min-width: 240px; border: 2px solid rgba(255, 255, 255, 0.2);">
                <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600;">‚è∞ Operating Hours</div>
                <div style="font-weight: 700; font-size: 1.05rem; line-height: 1.6;">üì¶ Orders: 9 AM - 5 PM</div>
                <div style="font-weight: 700; font-size: 1.05rem; margin-top: 2px; line-height: 1.6;">üöö Delivery: 7 PM - 9 PM</div>
            </div>
            <div style="text-align: center;">
                <a href="/shopkeeper-urgent.html" style="display: inline-block; background: linear-gradient(135deg, #ef4444, #dc2626); color: white; padding: 14px 28px; border-radius: 12px; text-decoration: none; font-weight: 700; font-size: 1rem; box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4); border: 2px solid rgba(255, 255, 255, 0.2); transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(239, 68, 68, 0.5)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 16px rgba(239, 68, 68, 0.4)';">
                    ‚ö° URGENT DELIVERY
                </a>
                <div style="margin-top: 5px; font-size: 0.75rem; color: #ef4444; font-weight: 600;">Within 1 Hour</div>
            </div>
            <div class="user-info">
                <p><strong id="user-name"></strong></p>
                <p id="shop-name"></p>
                <button onclick="logout()" class="btn btn-outline" style="margin-top: 10px; padding: 8px 16px; font-size: 0.9rem;">Logout</button>
            </div>
        </div>

        <div class="orders-section">
            <h2>Create New Order</h2>
            <div id="alert-container"></div>

            <form id="order-form">
                <div class="form-group">
                    <label for="orderContent">Order Details (Notepad Style)</label>
                    <textarea 
                        id="orderContent" 
                        name="orderContent" 
                        placeholder="Example:&#10;CC Board - 10 pieces&#10;Display - 5 pieces&#10;Battery - 20 pieces&#10;&#10;Type your order here..."
                        required
                    ></textarea>
                </div>

                <div class="form-group">
                    <label for="notes">Additional Notes (Optional)</label>
                    <input type="text" id="notes" name="notes" placeholder="Any special instructions">
                </div>

                <button type="submit" class="btn btn-primary">Submit Order</button>
            </form>
        </div>

        <div class="orders-section" style="margin-top: 30px;">
            <h2>My Orders</h2>
            <div id="orders-list" class="loading">Loading orders...</div>
        </div>
    </div>

    <script src="/js/config.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        // Check authentication
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        if (!token || user.role !== 'shopkeeper') {
            window.location.href = '/shopkeeper-login.html';
        }

        // Display user info
        document.getElementById('user-name').textContent = user.name;
        document.getElementById('shop-name').textContent = user.shopName;

        const alertContainer = document.getElementById('alert-container');
        const orderForm = document.getElementById('order-form');
        const ordersListDiv = document.getElementById('orders-list');

        // Submit order
        orderForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                orderContent: document.getElementById('orderContent').value,
                notes: document.getElementById('notes').value
            };

            try {
                const response = await fetch(`${API_URL}/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('Order submitted successfully!', 'success');
                    orderForm.reset();
                    loadOrders();
                } else {
                    showAlert(data.message || 'Failed to submit order', 'error');
                }
            } catch (error) {
                showAlert('Connection error. Please try again.', 'error');
            }
        });

        // Load orders
        async function loadOrders() {
            try {
                const response = await fetch(`${API_URL}/orders`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    displayOrders(data.orders);
                } else {
                    ordersListDiv.innerHTML = '<div class="empty-state">Failed to load orders</div>';
                }
            } catch (error) {
                ordersListDiv.innerHTML = '<div class="empty-state">Connection error</div>';
            }
        }

        function displayOrders(orders) {
            if (orders.length === 0) {
                ordersListDiv.innerHTML = '<div class="empty-state"><h3>No orders yet</h3><p>Submit your first order above</p></div>';
                return;
            }

            ordersListDiv.innerHTML = orders.map(order => `
                <div class="order-card" ${order.status === 'Deleted' ? 'style="opacity: 0.4; filter: blur(1px); background: #fee2e2; pointer-events: none;"' : ''}>
                    <div class="order-header">
                        <div class="order-info">
                            <h3>Order #${order._id.slice(-6)}</h3>
                            <p>${new Date(order.createdAt).toLocaleString()}</p>
                        </div>
                        <span class="order-status status-${order.status.toLowerCase()}">${order.status}</span>
                    </div>
                    <div class="order-content">${order.orderContent}</div>
                    ${order.notes ? `<p><strong>Notes:</strong> ${order.notes}</p>` : ''}
                    ${order.status === 'Delivered' ? `<p style="color: var(--secondary-color); margin-top: 10px;">‚úì Delivered by admin</p>` : ''}
                    ${order.status === 'Completed' ? `<p style="color: var(--secondary-color); margin-top: 10px;">‚úì‚úì Confirmed by superadmin</p>` : ''}
                    ${order.status === 'Deleted' ? `<p style="color: #991b1b; margin-top: 10px;">üóëÔ∏è Deleted on ${new Date(order.deletedAt).toLocaleString()}</p>` : ''}
                    ${order.status === 'Pending' ? `
                        <div style="margin-top: 15px;">
                            <button onclick="deleteOrder('${order._id}')" class="btn btn-danger" style="width: 100%; padding: 10px;">üóëÔ∏è Delete Order</button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        async function deleteOrder(orderId) {
            if (!confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
                return;
            }

            try {
                console.log('Deleting order:', orderId);
                console.log('API URL:', `${API_URL}/orders/${orderId}`);
                
                const response = await fetch(`${API_URL}/orders/${orderId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);

                if (response.ok) {
                    showAlert('Order deleted successfully', 'success');
                    loadOrders();
                } else {
                    showAlert(data.message || 'Failed to delete order', 'error');
                }
            } catch (error) {
                console.error('Delete error:', error);
                showAlert('Connection error. Please try again.', 'error');
            }
        }

        function showAlert(message, type) {
            alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/index.html';
        }

        // Load orders on page load
        loadOrders();
    </script>
</body>
</html>
