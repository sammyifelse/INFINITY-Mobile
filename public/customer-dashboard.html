<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Dashboard - Infinity Mobile</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body style="background: #f9fafb;">
    <div class="dashboard">
        <div class="dashboard-header">
            <div>
                <h1>üì± Infinity Mobile</h1>
                <p>Place Your Order</p>
            </div>
            <div style="background: linear-gradient(135deg, #ff9800, #ff5722); color: white; padding: 18px 30px; border-radius: 16px; text-align: center; box-shadow: 0 8px 20px rgba(255, 152, 0, 0.35); min-width: 240px; border: 2px solid rgba(255, 255, 255, 0.2);">
                <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600;">‚è∞ Operating Hours</div>
                <div style="font-weight: 700; font-size: 1.05rem; line-height: 1.6;">üì¶ Orders: 9 AM - 5 PM</div>
                <div style="font-weight: 700; font-size: 1.05rem; margin-top: 2px; line-height: 1.6;">üöö Delivery: 7 PM - 9 PM</div>
            </div>
            <div class="user-info">
                <p><strong id="user-name"></strong></p>
                <p id="user-address"></p>
                <p id="user-phone"></p>
                <button onclick="logout()" class="btn btn-outline" style="margin-top: 10px; padding: 8px 16px; font-size: 0.9rem;">Logout</button>
            </div>
        </div>

        <div class="orders-section">
            <h2>Create New Order</h2>
            <div id="alert-container"></div>

            <form id="order-form">
                <div class="form-group">
                    <label for="orderContent">Order Details</label>
                    <textarea 
                        id="orderContent" 
                        name="orderContent" 
                        placeholder="Example:&#10;iPhone 13 Back Cover - Blue&#10;Samsung A54 Tempered Glass&#10;Charging Cable Type-C&#10;&#10;Type your order here..."
                        required
                    ></textarea>
                </div>

                <div class="form-group">
                    <label for="notes">Additional Notes (Optional)</label>
                    <input type="text" id="notes" name="notes" placeholder="Any special instructions">
                </div>

                <button type="submit" class="btn btn-primary">Submit Order</button>
            </form>
        </div>

        <div class="orders-section" style="margin-top: 30px;">
            <h2>My Orders</h2>
            <div id="orders-list" class="loading">Loading orders...</div>
        </div>
    </div>

    <script src="/js/config.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        // Check authentication
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        if (!token || user.role !== 'customer') {
            window.location.href = '/customer-login.html';
        }

        // Display user info
        document.getElementById('user-name').textContent = user.name;
        document.getElementById('user-address').textContent = user.address;
        document.getElementById('user-phone').textContent = user.phoneNumber;

        const alertContainer = document.getElementById('alert-container');
        const orderForm = document.getElementById('order-form');
        const ordersListDiv = document.getElementById('orders-list');

        // Submit order
        orderForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                orderContent: document.getElementById('orderContent').value,
                notes: document.getElementById('notes').value
            };

            try {
                const response = await fetch(`${API_URL}/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('Order submitted successfully!', 'success');
                    orderForm.reset();
                    loadOrders();
                } else {
                    showAlert(data.message || 'Failed to submit order', 'error');
                }
            } catch (error) {
                showAlert('Connection error. Please try again.', 'error');
            }
        });

        // Load orders
        async function loadOrders() {
            try {
                const response = await fetch(`${API_URL}/orders`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    displayOrders(data.orders);
                } else {
                    ordersListDiv.innerHTML = '<div class="empty-state">Failed to load orders</div>';
                }
            } catch (error) {
                ordersListDiv.innerHTML = '<div class="empty-state">Connection error</div>';
            }
        }

        function displayOrders(orders) {
            if (orders.length === 0) {
                ordersListDiv.innerHTML = '<div class="empty-state"><h3>No orders yet</h3><p>Submit your first order above</p></div>';
                return;
            }

            ordersListDiv.innerHTML = orders.map(order => `
                <div class="order-card" ${order.status === 'Deleted' ? 'style="opacity: 0.4; filter: blur(1px); background: #fee2e2; pointer-events: none;"' : ''}>
                    <div class="order-header">
                        <div class="order-info">
                            <h3>Order #${order._id.slice(-6)}</h3>
                            <p>${new Date(order.createdAt).toLocaleString()}</p>
                        </div>
                        <span class="order-status status-${order.status.toLowerCase()}">${order.status}</span>
                    </div>
                    <div class="order-content">
                        <pre>${order.orderContent}</pre>
                        ${order.notes ? `<p class="notes"><strong>Notes:</strong> ${order.notes}</p>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/customer-login.html';
        }

        // Socket.IO connection for real-time updates
        const socket = io(SOCKET_URL, {
            auth: { token }
        });

        socket.on('connect', () => {
            console.log('Connected to server');
        });

        socket.on('orderStatusUpdated', (data) => {
            if (data.userId === user.id) {
                loadOrders();
                showAlert(`Order #${data.orderId.slice(-6)} status updated to: ${data.status}`, 'info');
            }
        });

        // Load orders on page load
        loadOrders();

        function showAlert(message, type) {
            alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
        }
    </script>
</body>
</html>
