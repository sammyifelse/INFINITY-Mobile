<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Superadmin Dashboard - Infinity Mobile</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body style="background: #f9fafb;">
    <div class="dashboard">
        <div class="dashboard-header">
            <div>
                <h1>üì± Infinity Mobile - Superadmin Panel</h1>
            </div>
            <div style="background: linear-gradient(135deg, #2196f3, #03a9f4); color: white; padding: 18px 30px; border-radius: 16px; text-align: center; box-shadow: 0 8px 20px rgba(33, 150, 243, 0.35); min-width: 240px; border: 2px solid rgba(255, 255, 255, 0.2);">
                <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600;">‚è∞ Operating Hours</div>
                <div style="font-weight: 700; font-size: 1.05rem; line-height: 1.6;">üì¶ Orders: 9 AM - 5 PM</div>
                <div style="font-weight: 700; font-size: 1.05rem; margin-top: 2px; line-height: 1.6;">üöö Delivery: 7 PM - 9 PM</div>
            </div>
            <div style="text-align: center;">
                <a href="/superadmin-urgent.html" style="display: inline-block; background: linear-gradient(135deg, #ef4444, #dc2626); color: white; padding: 14px 28px; border-radius: 12px; text-decoration: none; font-weight: 700; font-size: 1rem; box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4); border: 2px solid rgba(255, 255, 255, 0.2); transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(239, 68, 68, 0.5)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 16px rgba(239, 68, 68, 0.4)';">
                    ‚ö° URGENT DELIVERY
                </a>
                <div style="margin-top: 5px; font-size: 0.75rem; color: #ef4444; font-weight: 600;">Within 1 Hour</div>
            </div>
            <div class="user-info">
                <p><strong id="user-name"></strong></p>
                <p>Superadmin</p>
                <div class="notification-badge" style="margin: 10px 0;">
                    <button onclick="toggleNotifications()" class="btn btn-outline" style="padding: 8px 16px; font-size: 0.9rem;">
                        üîî Notifications
                        <span class="badge" id="notification-count" style="display: none;">0</span>
                    </button>
                </div>
                <button onclick="logout()" class="btn btn-outline" style="padding: 8px 16px; font-size: 0.9rem;">Logout</button>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 30px; box-shadow: var(--shadow);">
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="showTab('orders')" id="tab-orders" class="btn btn-primary" style="flex: 1; min-width: 150px;">Orders</button>
                <button onclick="showTab('admins')" id="tab-admins" class="btn btn-outline" style="flex: 1; min-width: 150px;">Manage Admins</button>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3 id="stat-total">0</h3>
                <p>Total Orders</p>
            </div>
            <div class="stat-card">
                <h3 id="stat-pending" style="color: var(--accent-color);">0</h3>
                <p>Pending Orders</p>
            </div>
            <div class="stat-card">
                <h3 id="stat-delivered" style="color: var(--primary-color);">0</h3>
                <p>Delivered</p>
            </div>
            <div class="stat-card">
                <h3 id="stat-completed" style="color: var(--secondary-color);">0</h3>
                <p>Completed</p>
            </div>
        </div>

        <!-- Notifications Panel -->
        <div id="notifications-panel" style="display: none; background: white; padding: 20px; border-radius: 12px; margin-bottom: 30px; box-shadow: var(--shadow);">
            <h2>Notifications</h2>
            <div id="notifications-list"></div>
        </div>

        <!-- Orders Tab -->
        <div id="orders-tab" class="orders-section">
            <h2>All Orders</h2>
            <div style="margin-bottom: 20px;">
                <select id="status-filter" style="padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; width: 200px;">
                    <option value="all">All Orders</option>
                    <option value="Pending">Pending</option>
                    <option value="Delivered">Delivered</option>
                    <option value="Completed">Completed</option>
                    <option value="Deleted">Deleted</option>
                </select>
            </div>
            <div id="orders-list" class="loading">Loading orders...</div>
        </div>

        <!-- Admins Tab -->
        <div id="admins-tab" class="orders-section" style="display: none;">
            <h2>Admin Management</h2>
            
            <!-- Create Admin Form -->
            <div style="background: var(--light-gray); padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                <h3>Create New Admin</h3>
                <div id="admin-alert-container"></div>
                <form id="create-admin-form">
                    <div class="form-group">
                        <label for="admin-name">Name</label>
                        <input type="text" id="admin-name" required>
                    </div>
                    <div class="form-group">
                        <label for="admin-username">Username</label>
                        <input type="text" id="admin-username" required>
                    </div>
                    <div class="form-group">
                        <label for="admin-password">Password (min 6 characters)</label>
                        <input type="password" id="admin-password" minlength="6" required>
                    </div>
                    <button type="submit" class="btn btn-secondary">Create Admin</button>
                </form>
            </div>

            <!-- Admin List -->
            <h3>Existing Admins</h3>
            <div id="admins-list" class="loading">Loading admins...</div>
        </div>
    </div>

    <script src="/js/config.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        // Check authentication
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        if (!token || user.role !== 'superadmin') {
            window.location.href = '/superadmin-login.html';
        }

        document.getElementById('user-name').textContent = user.name;

        let allOrders = [];
        let allAdmins = [];

        // Socket.IO connection
        const socket = io(SOCKET_URL, {
            auth: { token }
        });

        socket.on('connect', () => {
            console.log('Connected to socket server');
            socket.emit('joinRoom', 'superadmin');
        });

        socket.on('newOrder', (data) => {
            loadOrders();
            loadStats();
            loadNotifications();
            showToast('New order received from ' + data.shopName);
        });

        socket.on('orderDelivered', (data) => {
            loadOrders();
            loadStats();
            loadNotifications();
            showToast('Order delivered - ' + data.shopName);
        });

        socket.on('orderDeleted', (data) => {
            loadOrders();
            loadStats();
            loadNotifications();
            showToast('üóëÔ∏è Order deleted by ' + data.shopName);
        });

        // Tab management
        function showTab(tab) {
            document.getElementById('orders-tab').style.display = tab === 'orders' ? 'block' : 'none';
            document.getElementById('admins-tab').style.display = tab === 'admins' ? 'block' : 'none';
            
            document.getElementById('tab-orders').className = tab === 'orders' ? 'btn btn-primary' : 'btn btn-outline';
            document.getElementById('tab-admins').className = tab === 'admins' ? 'btn btn-primary' : 'btn btn-outline';

            if (tab === 'admins') {
                loadAdmins();
            }
        }

        // Load statistics
        async function loadStats() {
            try {
                const response = await fetch(`${API_URL}/orders/stats/dashboard`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('stat-total').textContent = data.stats.total;
                    document.getElementById('stat-pending').textContent = data.stats.pending;
                    document.getElementById('stat-delivered').textContent = data.stats.delivered;
                    document.getElementById('stat-completed').textContent = data.stats.completed;
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // Load notifications
        async function loadNotifications() {
            try {
                const response = await fetch(`${API_URL}/notifications`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    const badge = document.getElementById('notification-count');
                    if (data.unreadCount > 0) {
                        badge.textContent = data.unreadCount;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Failed to load notifications:', error);
            }
        }

        function toggleNotifications() {
            const panel = document.getElementById('notifications-panel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                loadNotificationsList();
            } else {
                panel.style.display = 'none';
            }
        }

        async function loadNotificationsList() {
            try {
                const response = await fetch(`${API_URL}/notifications`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                const notificationsList = document.getElementById('notifications-list');

                if (response.ok && data.notifications.length > 0) {
                    notificationsList.innerHTML = data.notifications.map(n => `
                        <div class="order-card" style="border-left-color: ${n.type === 'new_order' ? 'var(--primary-color)' : 'var(--secondary-color)'};">
                            <h4>${n.title}</h4>
                            <p>${n.message}</p>
                            <p style="font-size: 0.85rem; color: var(--text-color); margin-top: 5px;">${new Date(n.createdAt).toLocaleString()}</p>
                        </div>
                    `).join('');
                } else {
                    notificationsList.innerHTML = '<p>No notifications</p>';
                }
            } catch (error) {
                console.error('Failed to load notifications list:', error);
            }
        }

        // Load orders
        async function loadOrders() {
            try {
                const response = await fetch(`${API_URL}/orders`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    allOrders = data.orders;
                    filterOrders();
                } else {
                    document.getElementById('orders-list').innerHTML = '<div class="empty-state">Failed to load orders</div>';
                }
            } catch (error) {
                document.getElementById('orders-list').innerHTML = '<div class="empty-state">Connection error</div>';
            }
        }

        document.getElementById('status-filter').addEventListener('change', filterOrders);

        function filterOrders() {
            const filter = document.getElementById('status-filter').value;
            const filtered = filter === 'all' ? allOrders : allOrders.filter(o => o.status === filter);
            displayOrders(filtered);
        }

        function displayOrders(orders) {
            const ordersListDiv = document.getElementById('orders-list');
            
            if (orders.length === 0) {
                ordersListDiv.innerHTML = '<div class="empty-state"><h3>No orders found</h3></div>';
                return;
            }

            ordersListDiv.innerHTML = orders.map(order => `
                <div class="order-card" ${order.status === 'Deleted' ? 'style="opacity: 0.7; background: #fee2e2;"' : ''}>
                    <div class="order-header">
                        <div class="order-info">
                            <h3>${order.shopName}</h3>
                            <p><strong>${order.shopkeeperName}</strong> - ${order.phoneNumber}</p>
                            <p>Order #${order._id.slice(-6)} - ${new Date(order.createdAt).toLocaleString()}</p>
                        </div>
                        <span class="order-status status-${order.status.toLowerCase()}">${order.status}</span>
                    </div>
                    <div class="order-content">${order.orderContent}</div>
                    ${order.notes ? `<p><strong>Notes:</strong> ${order.notes}</p>` : ''}
                    ${order.deliveredBy ? `<p style="margin-top: 10px;"><strong>Delivered by:</strong> ${order.deliveredBy.name} on ${new Date(order.deliveredAt).toLocaleString()}</p>` : ''}
                    ${order.status === 'Deleted' ? `<p style="color: #991b1b; margin-top: 10px;">üóëÔ∏è Deleted by shopkeeper on ${new Date(order.deletedAt).toLocaleString()}</p>` : ''}
                    <div class="order-actions">
                        ${order.status === 'Delivered' ? `
                            <button onclick="markCompleted('${order._id}')" class="btn btn-secondary">Confirm as Completed</button>
                        ` : ''}
                        ${order.status === 'Completed' ? `
                            <p style="color: var(--secondary-color); padding: 10px;">‚úì‚úì Completed on ${new Date(order.completedAt).toLocaleString()}</p>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function markCompleted(orderId) {
            if (!confirm('Confirm this order as completed?')) return;

            try {
                const response = await fetch(`${API_URL}/orders/${orderId}/complete`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    showToast('Order marked as completed');
                    loadOrders();
                    loadStats();
                } else {
                    alert(data.message || 'Failed to update order');
                }
            } catch (error) {
                alert('Connection error. Please try again.');
            }
        }

        // Admin management
        document.getElementById('create-admin-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = {
                name: document.getElementById('admin-name').value,
                username: document.getElementById('admin-username').value,
                password: document.getElementById('admin-password').value
            };

            try {
                const response = await fetch(`${API_URL}/admin/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (response.ok) {
                    showAdminAlert('Admin created successfully', 'success');
                    document.getElementById('create-admin-form').reset();
                    loadAdmins();
                } else {
                    showAdminAlert(data.message || 'Failed to create admin', 'error');
                }
            } catch (error) {
                showAdminAlert('Connection error. Please try again.', 'error');
            }
        });

        async function loadAdmins() {
            try {
                const response = await fetch(`${API_URL}/admin/list`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    allAdmins = data.admins;
                    displayAdmins(data.admins);
                } else {
                    document.getElementById('admins-list').innerHTML = '<div class="empty-state">Failed to load admins</div>';
                }
            } catch (error) {
                document.getElementById('admins-list').innerHTML = '<div class="empty-state">Connection error</div>';
            }
        }

        function displayAdmins(admins) {
            const adminsListDiv = document.getElementById('admins-list');

            if (admins.length === 0) {
                adminsListDiv.innerHTML = '<div class="empty-state"><h3>No admins found</h3></div>';
                return;
            }

            adminsListDiv.innerHTML = admins.map(admin => `
                <div class="admin-card">
                    <div class="admin-details">
                        <h4>${admin.name}</h4>
                        <p><strong>Username:</strong> ${admin.username}</p>
                        <p><strong>Status:</strong> ${admin.isActive ? '<span style="color: var(--secondary-color);">Active</span>' : '<span style="color: var(--danger-color);">Inactive</span>'}</p>
                        <p style="font-size: 0.85rem; color: var(--text-color);">Created: ${new Date(admin.createdAt).toLocaleDateString()}</p>
                    </div>
                    <div class="admin-actions">
                        ${admin.isActive ? `
                            <button onclick="toggleAdminStatus('${admin._id}', false)" class="btn btn-outline">Deactivate</button>
                        ` : `
                            <button onclick="toggleAdminStatus('${admin._id}', true)" class="btn btn-secondary">Activate</button>
                        `}
                        <button onclick="deleteAdmin('${admin._id}')" class="btn btn-danger">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        async function toggleAdminStatus(adminId, activate) {
            const action = activate ? 'activate' : 'deactivate';
            if (!confirm(`Are you sure you want to ${action} this admin?`)) return;

            try {
                const response = await fetch(`${API_URL}/admin/${adminId}/${action}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    showToast(`Admin ${activate ? 'activated' : 'deactivated'} successfully`);
                    loadAdmins();
                } else {
                    alert(data.message || 'Failed to update admin');
                }
            } catch (error) {
                alert('Connection error. Please try again.');
            }
        }

        async function deleteAdmin(adminId) {
            if (!confirm('Are you sure you want to delete this admin? This action cannot be undone.')) return;

            try {
                const response = await fetch(`${API_URL}/admin/${adminId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    showToast('Admin deleted successfully');
                    loadAdmins();
                } else {
                    alert(data.message || 'Failed to delete admin');
                }
            } catch (error) {
                alert('Connection error. Please try again.');
            }
        }

        function showAdminAlert(message, type) {
            const alertContainer = document.getElementById('admin-alert-container');
            alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'alert alert-info';
            toast.textContent = message;
            toast.style.position = 'fixed';
            toast.style.top = '20px';
            toast.style.right = '20px';
            toast.style.zIndex = '9999';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/index.html';
        }

        // Load data on page load
        loadOrders();
        loadStats();
        loadNotifications();
    </script>
</body>
</html>
