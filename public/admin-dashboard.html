<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Infinity Mobile</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body style="background: #f9fafb;">
    <div class="dashboard">
        <div class="dashboard-header">
            <div>
                <h1>üì± Infinity Mobile - Admin Panel</h1>
            </div>
            <div style="background: linear-gradient(135deg, #4caf50, #8bc34a); color: white; padding: 18px 30px; border-radius: 16px; text-align: center; box-shadow: 0 8px 20px rgba(76, 175, 80, 0.35); min-width: 240px; border: 2px solid rgba(255, 255, 255, 0.2);">
                <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600;">‚è∞ Operating Hours</div>
                <div style="font-weight: 700; font-size: 1.05rem; line-height: 1.6;">üì¶ Orders: 9 AM - 5 PM</div>
                <div style="font-weight: 700; font-size: 1.05rem; margin-top: 2px; line-height: 1.6;">üöö Delivery: 7 PM - 9 PM</div>
            </div>
            <div style="text-align: center;">
                <a href="/admin-urgent.html" style="display: inline-block; background: linear-gradient(135deg, #ef4444, #dc2626); color: white; padding: 14px 28px; border-radius: 12px; text-decoration: none; font-weight: 700; font-size: 1rem; box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4); border: 2px solid rgba(255, 255, 255, 0.2); transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(239, 68, 68, 0.5)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 16px rgba(239, 68, 68, 0.4)';">
                    ‚ö° URGENT DELIVERY
                </a>
                <div style="margin-top: 5px; font-size: 0.75rem; color: #ef4444; font-weight: 600;">Within 1 Hour</div>
            </div>
            <div class="user-info">
                <p><strong id="user-name"></strong></p>
                <p>Admin</p>
                <div class="notification-badge" style="margin: 10px 0;">
                    <button onclick="toggleNotifications()" class="btn btn-outline" style="padding: 8px 16px; font-size: 0.9rem;">
                        üîî Notifications
                        <span class="badge" id="notification-count" style="display: none;">0</span>
                    </button>
                </div>
                <button onclick="logout()" class="btn btn-outline" style="padding: 8px 16px; font-size: 0.9rem;">Logout</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3 id="stat-total">0</h3>
                <p>Total Orders</p>
            </div>
            <div class="stat-card">
                <h3 id="stat-pending" style="color: var(--accent-color);">0</h3>
                <p>Pending Orders</p>
            </div>
            <div class="stat-card">
                <h3 id="stat-delivered" style="color: var(--primary-color);">0</h3>
                <p>Delivered</p>
            </div>
            <div class="stat-card">
                <h3 id="stat-completed" style="color: var(--secondary-color);">0</h3>
                <p>Completed</p>
            </div>
        </div>

        <div id="notifications-panel" style="display: none; background: white; padding: 20px; border-radius: 12px; margin-bottom: 30px; box-shadow: var(--shadow);">
            <h2>Notifications</h2>
            <div id="notifications-list"></div>
        </div>

        <div class="orders-section">
            <h2>All Orders</h2>
            <div style="margin-bottom: 20px;">
                <select id="status-filter" class="form-group" style="padding: 10px; border: 2px solid var(--border-color); border-radius: 8px;">
                    <option value="all">All Orders</option>
                    <option value="Pending">Pending</option>
                    <option value="Delivered">Delivered</option>
                    <option value="Completed">Completed</option>
                    <option value="Deleted">Deleted</option>
                </select>
            </div>
            <div id="orders-list" class="loading">Loading orders...</div>
        </div>
    </div>

    <script src="/js/config.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        // Check authentication
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        if (!token || user.role !== 'admin') {
            window.location.href = '/admin-login.html';
        }

        document.getElementById('user-name').textContent = user.name;

        const ordersListDiv = document.getElementById('orders-list');
        const statusFilter = document.getElementById('status-filter');
        let allOrders = [];

        // Socket.IO connection
        const socket = io(SOCKET_URL, {
            auth: { token }
        });

        socket.on('connect', () => {
            console.log('Connected to socket server');
            socket.emit('joinRoom', 'admin');
        });

        socket.on('newOrder', (data) => {
            loadOrders();
            loadStats();
            loadNotifications();
            showToast('New order received from ' + data.shopName);
        });

        socket.on('orderCompleted', (data) => {
            loadOrders();
            loadStats();
        });

        socket.on('orderDeleted', (data) => {
            loadOrders();
            loadStats();
            showToast('üóëÔ∏è Order deleted by ' + data.shopName);
        });

        // Load statistics
        async function loadStats() {
            try {
                const response = await fetch(`${API_URL}/orders/stats/dashboard`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('stat-total').textContent = data.stats.total;
                    document.getElementById('stat-pending').textContent = data.stats.pending;
                    document.getElementById('stat-delivered').textContent = data.stats.delivered;
                    document.getElementById('stat-completed').textContent = data.stats.completed;
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // Load notifications
        async function loadNotifications() {
            try {
                const response = await fetch(`${API_URL}/notifications`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    const badge = document.getElementById('notification-count');
                    if (data.unreadCount > 0) {
                        badge.textContent = data.unreadCount;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Failed to load notifications:', error);
            }
        }

        function toggleNotifications() {
            const panel = document.getElementById('notifications-panel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                loadNotificationsList();
            } else {
                panel.style.display = 'none';
            }
        }

        async function loadNotificationsList() {
            try {
                const response = await fetch(`${API_URL}/notifications`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                const notificationsList = document.getElementById('notifications-list');

                if (response.ok && data.notifications.length > 0) {
                    notificationsList.innerHTML = data.notifications.map(n => `
                        <div class="order-card" style="border-left-color: ${n.type === 'new_order' ? 'var(--primary-color)' : 'var(--secondary-color)'};">
                            <h4>${n.title}</h4>
                            <p>${n.message}</p>
                            <p style="font-size: 0.85rem; color: var(--text-color); margin-top: 5px;">${new Date(n.createdAt).toLocaleString()}</p>
                        </div>
                    `).join('');
                } else {
                    notificationsList.innerHTML = '<p>No notifications</p>';
                }
            } catch (error) {
                console.error('Failed to load notifications list:', error);
            }
        }

        // Load orders
        async function loadOrders() {
            try {
                const response = await fetch(`${API_URL}/orders`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    allOrders = data.orders;
                    filterOrders();
                } else {
                    ordersListDiv.innerHTML = '<div class="empty-state">Failed to load orders</div>';
                }
            } catch (error) {
                ordersListDiv.innerHTML = '<div class="empty-state">Connection error</div>';
            }
        }

        statusFilter.addEventListener('change', filterOrders);

        function filterOrders() {
            const filter = statusFilter.value;
            const filtered = filter === 'all' ? allOrders : allOrders.filter(o => o.status === filter);
            displayOrders(filtered);
        }

        function displayOrders(orders) {
            if (orders.length === 0) {
                ordersListDiv.innerHTML = '<div class="empty-state"><h3>No orders found</h3></div>';
                return;
            }

            ordersListDiv.innerHTML = orders.map(order => `
                <div class="order-card" ${order.status === 'Deleted' ? 'style="opacity: 0.7; background: #fee2e2;"' : ''}>
                    <div class="order-header">
                        <div class="order-info">
                            <h3>${order.shopName}</h3>
                            <p><strong>${order.shopkeeperName}</strong> - ${order.phoneNumber}</p>
                            <p>Order #${order._id.slice(-6)} - ${new Date(order.createdAt).toLocaleString()}</p>
                        </div>
                        <span class="order-status status-${order.status.toLowerCase()}">${order.status}</span>
                    </div>
                    <div class="order-content">${order.orderContent}</div>
                    ${order.notes ? `<p><strong>Notes:</strong> ${order.notes}</p>` : ''}
                    ${order.status === 'Deleted' ? `<p style="color: #991b1b; margin-top: 10px;">üóëÔ∏è Deleted by shopkeeper on ${new Date(order.deletedAt).toLocaleString()}</p>` : ''}
                    <div class="order-actions">
                        ${order.status === 'Pending' ? `
                            <button onclick="markDelivered('${order._id}')" class="btn btn-secondary">Mark as Delivered</button>
                        ` : ''}
                        ${order.status === 'Delivered' ? `
                            <p style="color: var(--primary-color); padding: 10px;">‚úì Delivered - Awaiting superadmin confirmation</p>
                        ` : ''}
                        ${order.status === 'Completed' ? `
                            <p style="color: var(--secondary-color); padding: 10px;">‚úì‚úì Completed</p>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function markDelivered(orderId) {
            if (!confirm('Mark this order as delivered?')) return;

            try {
                const response = await fetch(`${API_URL}/orders/${orderId}/deliver`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    showToast('Order marked as delivered');
                    loadOrders();
                    loadStats();
                } else {
                    alert(data.message || 'Failed to update order');
                }
            } catch (error) {
                alert('Connection error. Please try again.');
            }
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'alert alert-info';
            toast.textContent = message;
            toast.style.position = 'fixed';
            toast.style.top = '20px';
            toast.style.right = '20px';
            toast.style.zIndex = '9999';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/index.html';
        }

        // Load data on page load
        loadOrders();
        loadStats();
        loadNotifications();
    </script>
</body>
</html>
